<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th=""
      layout:decorator="project/layout">
<head layout:fragment="header" th:remove="tag">
    <script th:src="@{/vendors/amcharts/amcharts/amcharts.js}"></script>
    <script th:src="@{/vendors/amcharts/amcharts/serial.js}"></script>
    <script th:src="@{/vendors/amcharts/amcharts/pie.js}"></script>
    <script th:src="@{/vendors/amcharts/amcharts/radar.js}"></script>
    <script th:src="@{/vendors/amcharts/amcharts/themes/light.js}"></script>
    <script th:inline="javascript">
        var charts = {};

        var renderChartOnTabPanel = function(tabId) {
            var $tabDiv = $('#' + tabId);
            var $chartId = $tabDiv.find('.chart-canvas').attr('id');
            charts[$chartId].render();
            charts[$chartId].rendered = true;
        }

        $(document).ready(function(){
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var $tab = $(e.target);
                var tabId = $tab.attr('href').substr(1);
                renderChartOnTabPanel(tabId);
            });

            $('.tab-pane.active').each(function(){
                renderChartOnTabPanel($(this).attr('id'));
            });
        });
    </script>
</head>
<body>
<div layout:fragment="project_content">
    <h4 th:text="#{label.project.evaluation}"></h4>
    <div class="well">
        <a th:href="@{/project/{pid}/evaluation/result/csv(pid=${project.id})}" class="btn btn-primary">
            Download as CSV
        </a>
    </div>

    <div th:each="criterion,iter : ${criterionCharts}">

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title" th:text="${criterion.key.name}"></h3>
            </div>
            <div class="panel-body" role="tabpanel">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" th:class="${iter.index == 0} ? 'active' : ''" th:each="chart, iter : ${criterion.value}">
                        <a th:href="${'#' + criterion.key.id + '_tab_' + iter.index}" role="tab" data-toggle="tab" th:text="#{${chart.key}}"></a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div th:each="chart, iter : ${criterion.value}" role="tabpanel" class="tab-pane" th:classAppend="${iter.index == 0} ? 'active' : ''" th:id="${criterion.key.id + '_tab_' + iter.index}">
                        <div th:id="${criterion.key.id} + '_chart_' +  ${iter.index}" class="chart-canvas" style="width: 100%; height: 400px;">
                            Chart
                        </div>

                        <script th:inline="javascript">
                            /*[+
                             charts[ [[${criterion.key.id} + '_chart_' + ${iter.index}]] ] = {};
                             charts[ [[${criterion.key.id} + '_chart_' + ${iter.index}]] ].rendered = false;
                             charts[ [[${criterion.key.id} + '_chart_' + ${iter.index}]] ].render = function() {
                                if(this.rendered === false) {
                                    var a = [[${chart.value}]];
                                    var divId = [[${criterion.key.id} + '_chart_' + ${iter.index}]];
                                    var json = JSON.parse(a);
                                    AmCharts.makeChart(divId, json);
                                }
                             };
                             +]*/
                        </script>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
</body>
</html>