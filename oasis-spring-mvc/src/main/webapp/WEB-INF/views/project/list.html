<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout_containered">
<head layout:fragment="header" th:remove="tag">
      <script th:src="@{/vendors/tinymce/tinymce.min.js}"></script>
      <script th:inline="javascript">
            $(document).ready(function() {
                  var token = $("meta[name='_csrf']").attr("content");
                  var header = $("meta[name='_csrf_header']").attr("content");

                  $('#addProjectModal').on('show.bs.modal', function (event) {
                        var button = $(event.relatedTarget);
                        var memberId = button.data('member-id');
                        var modal = $(this);
                        var url = /*[[@{/api/project}]]*/ '';
                        var form = modal.find('form');

                        OASIS.form.hideErrors(form);

                        modal.find('button.save').on('click', function() {
                              var $btn = $(this);
                              $btn.button('loading');

                              var content = tinymce.get('description').getContent();

                              form.find('#description').val(content);

                              var data = {
                                    name: form.find('#name').val(),
                                    description: form.find('#description').val()
                              }

                              var promise = $.ajax({
                                    url: url,
                                    data: JSON.stringify(data),
                                    contentType : 'application/json; charset=utf-8',
                                    dataType : 'json',
                                    type: 'POST',
                                    beforeSend: function( xhr ) {
                                          xhr.setRequestHeader(header, token);
                                    }
                              });
                              promise.success(function(data) {
                                    data = JSON.parse(data);
                                    if(data.ok !== undefined && data.ok === true) {
                                          window.location.reload();
                                    } else {
                                          $btn.button('reset');
                                          OASIS.form.showErrors(form, data.errors);
                                    }
                              });
                        });
                  });

                  $('.btn-delete').on('click', function(event) {
                        event.preventDefault();

                        var id = $(this).data('id');
                        if(id !== undefined) {
                              var promise = $.ajax({
                                    url: '/api/project/' + id,
                                    type: 'DELETE',
                                    beforeSend: function( xhr ) {
                                          xhr.setRequestHeader(header, token);
                                    }
                              });
                              promise.success(function(data) {
                                    data = JSON.parse(data);
                                    if(data.ok !== undefined && data.ok === true) {
                                          window.location.reload();
                                    }
                              });
                        }
                  });
            });
            tinymce.init({
                  selector: "textarea.editor",
                  plugins : "paste",
                  paste_as_text: true,
                  toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist',
                  height: 300,
                  content_css: /*[[@{/css/tinymce.css}]]*/ '/css/tinymce.css'
            });
      </script>
</head>
<body layout:fragment="content">
      <div>
            <a href="" class="btn btn-default btn-primary" data-toggle="modal" data-target="#addProjectModal">
                  <span class="fa fa-plus"></span>
                  <span th:text="#{label.create(#{label.project})}"></span>
            </a>
      </div>

      <table class="table">
            <thead>
                  <tr>
                        <th th:text="#{table.header.name}">Name/Bezeichnung</th>
                        <th th:text="#{table.header.actions}" class="actions text-right">Aktionen</th>
                  </tr>
            </thead>
            <tbody>
                  <tr th:each="project : ${projects}">
                        <td>
                              <span th:text="${project.name}"></span>
                        </td>
                        <td class="actions text-right">
                              <a th:href="@{/project/{id}(id=${project.id})}" class="btn btn-xs btn-default" th:text="#{label.details}">
                                    Details
                              </a>
                              <a th:href="@{/project/{id}(id=${project.id})}" th:attr="data-id=${project.id}" class="btn btn-xs btn-danger btn-delete" th:text="#{label.delete}">
                                    Löschen
                              </a>
                        </td>
                  </tr>

                  <tr th:if="${projects.size() == 0}">
                        <td colspan="2" class="text-center" th:text="noItemLabel">
                              Keine Einträge vorhanden!
                        </td>
                  </tr>
            </tbody>
      </table>

      <div>
            <div class="text-center" wicket:id="navigator.counter"></div>
            <div wicket:id="navigator" class="text-center"></div>
      </div>

      <div th:replace="project/modals :: addProjectModal"></div>
</body>
</html>